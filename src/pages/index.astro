---
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import BackToTopButton from "@/components/BackToTopButton.astro";
import { SITE } from "@/config";
import Layout from "@/layouts/Layout.astro";
import { getCollection } from "astro:content";
import { parseEntry } from "@/utils/parseEntry";
import DiaryTimeline from "@/components/DiaryTimeline.tsx";

const diaryEntries = await getCollection("diary");

// 过滤掉草稿状态的条目
const publishedEntries = diaryEntries.filter(entry => !entry.data.draft);

// 按文件名（日期）排序，最新的在前
// 同时确保同一天内的时间块也按时间倒序排列
const sortedEntries = publishedEntries.sort((a, b) => {
  const dateA = a.id.replace(".md", "");
  const dateB = b.id.replace(".md", "");
  return dateB.localeCompare(dateA);
});

// 分页设置
const ITEMS_PER_PAGE = 5;
const initialEntries = sortedEntries.slice(0, ITEMS_PER_PAGE);

// 解析初始数据
const initialParsedEntries = await Promise.all(initialEntries.map(parseEntry));

// 为了性能考虑，只解析初始数据，其他数据通过API端点按需加载
// 创建分页数据结构
const totalPages = Math.ceil(sortedEntries.length / ITEMS_PER_PAGE);
const paginationInfo = {
  currentPage: 1,
  totalPages,
  hasMore: totalPages > 1,
  itemsPerPage: ITEMS_PER_PAGE,
};
---

<Layout title={`时间档案 | ${SITE.title}`}>
  <Header />

  <main
    id="main-content"
    data-pagefind-ignore
    role="main"
    aria-label="时间档案主要内容"
  >
    <!-- 跳转到主要内容的链接 -->
    <a
      href="#diary-content"
      class="focus:bg-skin-accent focus:text-skin-inverted sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:rounded focus:px-4 focus:py-2 focus:no-underline"
    >
      跳转到主要内容
    </a>

    <section
      id="diary"
      class="from-skin-fill via-skin-card to-skin-fill mx-auto min-h-screen max-w-app bg-gradient-to-br px-4 pt-4"
      role="region"
      aria-labelledby="diary-heading"
    >
      <div class="min-h-screen">
        <!-- 页面标题 -->
        <header class="py-0">
          <h1 id="diary-heading" class="sr-only">时间档案</h1>
          <p class="sr-only">
            按时间顺序展示的日记条目，支持无限滚动加载更多内容
          </p>
        </header>

        <!-- 主要内容区域 -->
        <div class="py-8">
          <div
            id="diary-content"
            role="feed"
            aria-label="日记时间线"
            aria-describedby="diary-description"
            aria-live="polite"
            aria-busy="false"
          >
            <div id="diary-description" class="sr-only">
              日记条目按时间倒序排列，每页显示 {ITEMS_PER_PAGE} 条记录，当前共有
              {sortedEntries.length} 条记录
            </div>
            <DiaryTimeline
              client:load
              initialEntries={initialParsedEntries}
              paginationInfo={paginationInfo}
            />
          </div>
        </div>

        <BackToTopButton />
      </div>
    </section>
  </main>

  <Footer />
</Layout>

<style>
  /* 添加一些动画效果 */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .diary-item {
    animation: fadeInUp 0.6s ease-out;
  }
</style>
